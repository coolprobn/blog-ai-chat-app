<% content_for :body_class, "h-screen overflow-hidden" %>

<div class="flex h-full bg-[#f7f7f8]">
  <%# Left sidebar — ChatGPT-style %>
  <aside class="flex w-64 shrink-0 flex-col border-r border-gray-200 bg-[#171717] text-gray-300">
    <%# New chat button %>
    <div class="border-b border-gray-800 p-3">
      <%= button_to chats_path,
                    method: :post,
                    class: "flex w-full items-center gap-3 rounded-lg border border-gray-700 bg-transparent px-3 py-2.5 text-sm font-medium text-white hover:bg-gray-800 transition-colors" do %>
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New chat
      <% end %>
    </div>

    <%# Chat list — scrollable %>
    <div class="flex-1 overflow-y-auto">
      <% chats = Chat.order(created_at: :desc).limit(20) %>
      <% if chats.any? %>
        <nav class="p-2">
          <% chats.each do |chat| %>
            <%= link_to chat_path(chat),
                        class: "group flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm text-gray-300 hover:bg-gray-800 mb-1 transition-colors #{'bg-gray-800' if chat.id == @chat.id}" do %>
              <svg class="h-4 w-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <span class="min-w-0 flex-1 truncate">
                <% if (last_message = chat.messages.order(created_at: :desc).first) %>
                  <%= last_message.content.to_s.truncate(30) %>
                <% else %>
                  New chat
                <% end %>
              </span>
            <% end %>
          <% end %>
        </nav>
      <% else %>
        <div class="p-4 text-center text-sm text-gray-500">
          No chats yet
        </div>
      <% end %>
    </div>
  </aside>

  <%# Main chat area %>
  <main class="flex flex-1 flex-col">
    <%# Scrollable message area %>
    <div id="chat-messages" class="flex-1 overflow-y-auto" data-controller="scroll-to-bottom">
      <div class="mx-auto max-w-3xl px-4 py-6">
        <% if @chat.messages.empty? %>
          <div class="flex flex-col items-center justify-center py-16 text-center">
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-gray-500">
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <p class="text-lg font-medium text-gray-700">Ask about my blog</p>
            <p class="mt-1 max-w-sm text-sm text-gray-500">I'll search the blog and answer using that content.</p>
          </div>
        <% else %>
          <% @chat.messages.order(:created_at).each do |message| %>
            <% next if ["user", "assistant"].exclude?(message.role) || message.content.blank? %>

            <div class="mb-6 flex gap-3 <%= message.role == 'user' ? 'flex-row-reverse' : '' %>">
              <%# Avatar %>
              <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full <%= message.role == 'user' ? 'bg-emerald-500 text-white' : 'bg-[#10a37f] text-white' %>">
                <% if message.role == "user" %>
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <% elsif message.role == "assistant" %>
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                <% end %>
              </div>
              <%# Message bubble %>
              <div class="flex min-w-0 max-w-[85%] flex-1 flex-col <%= message.role == 'user' ? 'items-end' : 'items-start' %>">
                <div class="rounded-2xl px-4 py-2.5 <%= message.role == 'user' ? 'bg-[#10a37f] text-white' : 'bg-white text-gray-800 shadow-sm ring-1 ring-gray-200/80' %>">
                  <% if message.role == "assistant" %>
                    <div class="chat-markdown text-[15px] leading-relaxed [&_p]:mb-2 [&_p:last-child]:mb-0 [&_ul]:list-disc [&_ul]:pl-5 [&_ol]:list-decimal [&_ol]:pl-5 [&_li]:my-0.5 [&_pre]:my-2 [&_pre]:rounded-lg [&_pre]:bg-gray-100 [&_pre]:p-3 [&_pre]:overflow-x-auto [&_code]:rounded [&_code]:bg-gray-100 [&_code]:px-1 [&_code]:py-0.5 [&_a]:text-[#10a37f] [&_a]:underline">
                      <%= Redcarpet::Markdown.new(Redcarpet::Render::HTML.new(filter_html: true), fenced_code_blocks: true, autolink: true).render(message.content.to_s).html_safe %>
                    </div>
                  <% elsif message.role == "user" %>
                    <p class="whitespace-pre-wrap text-[15px]"><%= message.content %></p>
                  <% end %>
                </div>
                <span class="mt-1 px-1 text-xs text-gray-400"><%= message.created_at.strftime("%H:%M") %></span>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Sticky input area — ChatGPT-style %>
    <div class="shrink-0 border-t border-gray-200 bg-[#f7f7f8] px-4 pb-6 pt-4">
      <div class="mx-auto max-w-3xl">
        <%= form_with model: [@chat, @message],
                      url: chat_messages_path(@chat),
                      method: :post,
                      local: true,
                      class: "relative flex items-end gap-2 rounded-2xl border border-gray-300 bg-white shadow-sm ring-1 ring-gray-200/80 focus-within:ring-2 focus-within:ring-[#10a37f]/30 focus-within:border-[#10a37f]" do |f| %>
          <%= f.text_area :content,
                          rows: 1,
                          placeholder: "Message…",
                          class: "max-h-48 w-full resize-none rounded-2xl border-0 bg-transparent py-3 pl-4 pr-12 text-[15px] text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-0",
                          data: { controller: "auto-resize", action: "input->auto-resize#resize" } %>
          <button type="submit"
                  class="absolute bottom-2 right-2 flex h-8 w-8 shrink-0 items-center justify-center rounded-lg bg-[#10a37f] text-white hover:bg-[#0d8c6a] disabled:opacity-50">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        <% end %>
      </div>
    </div>
  </main>
</div>
